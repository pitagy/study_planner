'use client';

import { useEffect, useMemo, useState } from 'react';
import dayjs from 'dayjs';
import 'dayjs/locale/ko';
import {
  ResponsiveContainer,
  BarChart,
  Bar,
  CartesianGrid,
  XAxis,
  YAxis,
  Tooltip,
  Legend,
  LabelList,
} from 'recharts';
import * as SB from '@/lib/supabaseClient';


dayjs.locale('ko');

const WEEK_LABELS = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];
const BG_LIGHT = '#f3f4f6';
const COLOR_PLAN = '#f97316';
const COLOR_ACTUAL = '#15803d';

const pickSupabase = () =>
  typeof (SB as any).getSupabaseBrowser === 'function'
    ? (SB as any).getSupabaseBrowser()
    : (SB as any).getSupabaseClient();

function heatColor(v: number) {
  if (v <= 0) return '#e5e7eb';
  if (v < 60) return '#bfdbfe';
  if (v < 120) return '#93c5fd';
  if (v < 180) return '#60a5fa';
  if (v < 300) return '#3b82f6';
  return '#1d4ed8';
}

export default function ViewerDashboard({ viewerId, viewerName, viewerRole = 'student' }: any) {
  const supabase = useMemo(() => pickSupabase(), []);
  const [myUid, setMyUid] = useState<string | null>(null);
  const [displayName, setDisplayName] = useState('ëŒ€ì‹œë³´ë“œ');
  const [loading, setLoading] = useState(true);
  const [monthOffset, setMonthOffset] = useState(0);
  const [selectedDate, setSelectedDate] = useState(dayjs().format('YYYY-MM-DD'));

  const [monthCells, setMonthCells] = useState<any[]>([]);
  const [memoDates, setMemoDates] = useState<{ date: string; count: number }[]>([]);
  const [todayMemos, setTodayMemos] = useState<any[]>([]);
  const [summaryData, setSummaryData] = useState<any[]>([]);
  const [aiSummary, setAiSummary] = useState('');
  const [aiRange, setAiRange] = useState('');
  const [newMemo, setNewMemo] = useState('');

  /** ì´ˆê¸°í™” */
  useEffect(() => {
    (async () => {
      const { data: auth } = await supabase.auth.getUser();
      const uid = auth?.user?.id ?? null;
      setMyUid(uid);
    })();
  }, [supabase]);

  /** ë°ì´í„° ë¡œë“œ */
  useEffect(() => {
    if (viewerId) loadAll();
  }, [viewerId, monthOffset]);

  /** ì „ì²´ ë°ì´í„° ë¡œë“œ */
  const loadAll = async () => {
	  setLoading(true);
	  try {
		const today = dayjs();
		const base = today.add(monthOffset, 'month');
		const startOfMonth = base.startOf('month');
		const endOfMonth = base.endOf('month');
		const startOfWeek = today.startOf('week');
		const endOfWeek = today.endOf('week');

		// âœ… í”„ë¡œí•„
		const { data: profile } = await supabase
		  .from('profiles')
		  .select('name,email')
		  .eq('id', viewerId)
		  .single();
		const name =
		  profile?.name?.trim() || profile?.email?.split('@')[0] || 'í•™ìƒ';
		setDisplayName(
		  myUid === viewerId
			? 'ë‚˜ì˜ ëŒ€ì‹œë³´ë“œ'
			: `${viewerName || name} í•™ìƒì˜ ëŒ€ì‹œë³´ë“œ`
		);

		// âœ… ê³„íš + ì‹¤ì œ ë°ì´í„°
		const [plansRes, sessRes] = await Promise.all([
		  supabase
			.from('plans')
			.select('subject,start_at,end_at')
			.eq('user_id', viewerId)
			.gte('start_at', startOfMonth.toISOString())
			.lte('end_at', endOfMonth.toISOString()),
		  supabase
			.from('sessions')
			.select('subject,actual_start,actual_end,duration_min')
			.eq('user_id', viewerId)
			.gte('actual_start', startOfMonth.toISOString())
			.lte('actual_end', endOfMonth.toISOString()),
		]);

		const plans = plansRes.data || [];
		const sessions = sessRes.data || [];

		// âœ… ì˜¤ëŠ˜ ìš”ì•½ (KST)
		const todayPlans = plans.filter((p) =>
		  dayjs(p.start_at).add(9, 'hour').isSame(dayjs(), 'day')
		);
		const todaySessions = sessions.filter((s) =>
		  dayjs(s.actual_start).add(9, 'hour').isSame(dayjs(), 'day')
		);
		setSummaryData(mergeSubjectCompare(todayPlans, todaySessions));

		// âœ… íˆíŠ¸ë§µ êµ¬ì„±
		const daysInMonth = endOfMonth.date();
		const offset = startOfMonth.day();
		const cells: any[] = [];
		for (let i = 0; i < offset; i++)
		  cells.push({ key: `blank-${i}`, date: null, minutes: 0 });
		for (let d = 1; d <= daysInMonth; d++) {
		  const date = startOfMonth.date(d);
		  const dateStr = date.format('YYYY-MM-DD');
		  const mins = sessions
			.filter((s) => dayjs(s.actual_start).isSame(date, 'day'))
			.reduce((acc, s) => acc + (s.duration_min ?? 0), 0);
		  cells.push({ key: dateStr, date: dateStr, minutes: mins });
		}
		setMonthCells(cells);

		// âœ… ë©”ëª¨ ë‚ ì§œ ëª©ë¡
		const { data: memos } = await supabase
		  .from('dashboard_comments')
		  .select('date')
		  .eq('user_id', viewerId)
		  .gte('date', startOfMonth.format('YYYY-MM-DD'))
		  .lte('date', endOfMonth.format('YYYY-MM-DD'));

		const memoCounts: Record<string, number> = {};
		(memos || []).forEach((m: any) => {
		  memoCounts[m.date] = (memoCounts[m.date] || 0) + 1;
		});
		const memoArr = Object.keys(memoCounts).map((d) => ({
		  date: d,
		  count: memoCounts[d],
		}));
		setMemoDates(memoArr);

		// âœ… ì˜¤ëŠ˜ ë©”ëª¨
		const { data: todayList } = await supabase
		  .from('dashboard_comments')
		  .select('*')
		  .eq('user_id', viewerId)
		  .eq('date', dayjs().format('YYYY-MM-DD'))
		  .order('created_at');
		setTodayMemos(todayList || []);

		// âœ… AI ìš”ì•½ ë°ì´í„°
		const { data: ai } = await supabase
		  .from('dashboard_ai')
		  .select('*')
		  .eq('user_id', viewerId)
		  .gte('start_date', startOfWeek.format('YYYY-MM-DD'))
		  .lte('end_date', endOfWeek.format('YYYY-MM-DD'))
		  .maybeSingle();

		if (ai?.summary && ai.summary.trim() !== '') {
		  // âœ… ìš”ì•½ ë°ì´í„°ê°€ ì¡´ì¬í•  ë•Œ
		  setAiSummary(ai.summary);
		  setAiRange(
			`${startOfWeek.format('M/D(ì›”)')}~${endOfWeek.format(
			  'M/D(ì¼)'
			)} AI í•™ìŠµ ìš”ì•½`
		  );
		} else {
		  // âœ… ìš”ì•½ ë°ì´í„°ê°€ ì—†ì„ ë•Œ: ì§ì ‘ ê³„ì‚°

		  const weekPlans =
			(
			  await supabase
				.from('plans')
				.select('start_at,end_at')
				.eq('user_id', viewerId)
				.gte('start_at', startOfWeek.toISOString())
				.lte('end_at', endOfWeek.toISOString())
			).data || [];

		  const weekSessions =
			(
			  await supabase
				.from('sessions')
				.select('actual_start,actual_end,duration_min')
				.eq('user_id', viewerId)
				.gte('actual_start', startOfWeek.toISOString())
				.lte('actual_end', endOfWeek.toISOString())
			).data || [];

		  // ğŸ”¸ ë¶„ ë‹¨ìœ„ ê³„ì‚°
		  const planMinutes = weekPlans.reduce((acc, p) => {
			const dur = dayjs(p.end_at).diff(dayjs(p.start_at), 'minute');
			return acc + (dur > 0 ? dur : 0);
		  }, 0);

		  const actualMinutes = weekSessions.reduce((acc, s) => {
			const dur =
			  s.duration_min ??
			  dayjs(s.actual_end).diff(dayjs(s.actual_start), 'minute');
			return acc + (dur > 0 ? dur : 0);
		  }, 0);

		  // ğŸ”¸ ë¶„ â†’ "ì‹œê°„+ë¶„" ë‹¨ìœ„ ë³€í™˜
		  const formatHM = (mins: number) => {
			const h = Math.floor(mins / 60);
			const m = mins % 60;
			return h > 0 ? `${h}ì‹œê°„ ${m}ë¶„` : `${m}ë¶„`;
		  };

		  const planHM = formatHM(planMinutes);
		  const actualHM = formatHM(actualMinutes);

		  // ğŸ”¸ ì‹¤ì²œìœ¨ ê³„ì‚°
		  const rate =
			planMinutes > 0 ? Math.round((actualMinutes / planMinutes) * 100) : 0;

		  // ğŸ”¸ í‰ê°€ ë¬¸êµ¬
		  let evaluation = '';
		  if (rate <= 40) {
			evaluation = 'ì €ì¡°í•œ í¸ì…ë‹ˆë‹¤. ì¢€ ë” ë¶„ë°œí•˜ì—¬ ì£¼ì„¸ìš”.';
		  } else if (rate <= 79) {
			evaluation =
			  'ì–‘í˜¸í•œ í¸ì…ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì•„ì§ ì¡°ê¸ˆ ë¶€ì¡±í•©ë‹ˆë‹¤. í˜ë‚´ì„¸ìš”. í™”ì´íŒ…!!';
		  } else {
			evaluation =
			  'ì™€ìš°~~ ì—´ì‹¬íˆ í•˜ê³  ìˆêµ°ìš”. ì¡°ê¸ˆë§Œ ë” í˜ë‚´ì„œ ëª©í‘œë¥¼ ë‹¬ì„±í•˜ë„ë¡ í•´ìš”!!';
		  }

		  // ğŸ”¸ ìµœì¢… ë¬¸ì¥
		  const summaryText =
			`ë§¤ì£¼ ì¼ìš”ì¼ AI í•™ìŠµ ìš”ì•½ì´ ìƒì„±ë©ë‹ˆë‹¤. ì•„ì§ í•™ìŠµì— ëŒ€í•œ ìš”ì•½ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n` +
			`í˜„ì¬ê¹Œì§€ ê³„íš ê³µë¶€ ì‹œê°„ì€ ${planHM}ì´ë©° ì‹¤ì œ ê³µë¶€ ì‹œê°„ì€ ${actualHM}ì…ë‹ˆë‹¤.\n` +
			`ì´ì— ë”°ë¥¸ ì‹¤ì²œìœ¨ì€ ${rate}%ë¡œ ${evaluation}`;

		  setAiSummary(summaryText);
		  setAiRange(
			`${startOfWeek.format('M/D(ì›”)')}~${endOfWeek.format(
			  'M/D(ì¼)'
			)} AI í•™ìŠµ ìš”ì•½`
		  );
		}
	  } finally {
		setLoading(false);
	  }
	};

  /** ì˜¤ëŠ˜ ë©”ëª¨ ì €ì¥ */
  const handleSaveMemo = async () => {
    if (!newMemo.trim()) return;
    const today = dayjs().format('YYYY-MM-DD');
    await supabase.from('dashboard_comments').insert([
      {
        user_id: viewerId,
        date: today,
        content: newMemo,
        author_name: viewerName || 'í•™ìƒ',
        role: viewerRole,
        created_at: new Date().toISOString(),
      },
    ]);
    setNewMemo('');
    handleDateClick(today);
  };
// 2
  /** ë‚ ì§œ í´ë¦­ ì‹œ */
  const handleDateClick = async (dateStr: string) => {
    setSelectedDate(dateStr);

    const start = dayjs(dateStr).startOf('day').add(9, 'hour').toISOString();
    const end = dayjs(dateStr).endOf('day').add(9, 'hour').toISOString();

    const [plansRes, sessRes, memosRes] = await Promise.all([
      supabase
        .from('plans')
        .select('subject,start_at,end_at')
        .eq('user_id', viewerId)
        .gte('start_at', start)
        .lte('end_at', end),
      supabase
        .from('sessions')
        .select('subject,actual_start,actual_end,duration_min')
        .eq('user_id', viewerId)
        .gte('actual_start', start)
        .lte('actual_end', end),
      supabase.from('dashboard_comments').select('*').eq('user_id', viewerId).eq('date', dateStr),
    ]);

    const plans = plansRes.data || [];
    const sessions = sessRes.data || [];
    setSummaryData(mergeSubjectCompare(plans, sessions));

    const memos = memosRes.data || [];
    const rootMemos = memos.filter((m) => !m.parent_id);
    const replies = memos.filter((m) => m.parent_id);
    const grouped = rootMemos.map((root) => ({
      ...root,
      replies: replies.filter((r) => r.parent_id === root.id),
    }));
    setTodayMemos(grouped);
  };

  if (loading) return <main className="p-6 text-gray-600">ğŸ“Š ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</main>;

  const currentMonth = dayjs().add(monthOffset, 'month');

  return (
    <main className="p-6 space-y-8">
      <h1 className="text-2xl font-bold">{displayName}</h1>

      {/* âœ… AI ìš”ì•½ ì¹´ë“œ */}
      <section className="bg-gradient-to-r from-indigo-50 to-white border rounded-lg p-4 shadow-sm">
        <h2 className="font-semibold mb-1 text-indigo-700">ğŸ¤– {aiRange}</h2>
        <p className="text-gray-700 whitespace-pre-wrap">{aiSummary}</p>
      </section>

      {/* âœ… ì˜¤ëŠ˜ì˜ ë©”ëª¨ ì¹´ë“œ */}
      <section className="bg-white border rounded-lg p-4 shadow-sm">
        <h2 className="font-semibold mb-2">ğŸ“ ì˜¤ëŠ˜ì˜ ë©”ëª¨ ({dayjs().format('Mì›” Dì¼')})</h2>
        <textarea
          value={newMemo}
          onChange={(e) => setNewMemo(e.target.value)}
          placeholder="ì˜¤ëŠ˜ ëŠë‚€ ì ì´ë‚˜ ê¸°ë¡ì„ ì…ë ¥í•˜ì„¸ìš”..."
          className="w-full border rounded p-2 mb-2 resize-none h-24"
        />
        <button
          onClick={handleSaveMemo}
          className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
        >
          ì €ì¥
        </button>
        <div className="mt-4 border-t pt-3 text-sm space-y-1">
          {todayMemos.length === 0 ? (
            <p className="text-gray-500">ì˜¤ëŠ˜ ì‘ì„±ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
          ) : (
            todayMemos.map((m) => (
              <div key={m.id}>
                <span className="text-blue-600 font-medium">{m.author_name}</span> â€” {m.content}
              </div>
            ))
          )}
        </div>
      </section>

      {/* âœ… íˆíŠ¸ë§µ */}
      <section className="bg-white rounded-lg border p-4">
        <div className="flex items-center justify-between mb-2">
          <h2 className="font-semibold">ğŸ“… {currentMonth.format('YYYYë…„ Mì›”')} í•™ìŠµ íˆíŠ¸ë§µ</h2>
          <div className="space-x-2">
            <button onClick={() => setMonthOffset((p) => p - 1)} className="px-2 py-1 text-sm border rounded">
              â—€ ì´ì „ë‹¬
            </button>
            <button onClick={() => setMonthOffset(0)} className="px-2 py-1 text-sm border rounded">
              ì´ë²ˆë‹¬
            </button>
            <button onClick={() => setMonthOffset((p) => p + 1)} className="px-2 py-1 text-sm border rounded">
              ë‹¤ìŒë‹¬ â–¶
            </button>
          </div>
        </div>

        {/* ìš”ì¼ */}
        <div className="grid grid-cols-7 text-center text-sm text-gray-500 mb-2">
          {WEEK_LABELS.map((w) => (
            <div key={w}>{w}</div>
          ))}
        </div>

        <div className="grid grid-cols-7 gap-2">
          {monthCells.map((c) => {
            if (!c.date) return <div key={c.key} className="w-16 h-16" />;
            const memoCount = memoDates.find((m) => m.date === c.date)?.count || 0;
            const isSelected = selectedDate === c.date;
            return (
              <button
                key={c.key}
                onClick={() => handleDateClick(c.date!)}
                className={`relative w-16 h-16 rounded-md text-sm font-medium ${
                  isSelected ? 'ring-2 ring-blue-600' : 'hover:ring-2 hover:ring-blue-400'
                }`}
                style={{ backgroundColor: c.minutes > 0 ? heatColor(c.minutes) : BG_LIGHT }}
              >
                <div className="absolute left-1 top-1 text-[11px]">{dayjs(c.date).date()}</div>
                {memoCount > 0 && (
                  <div className="absolute right-1 top-1 bg-blue-700 text-white rounded-full w-5 h-5 text-[10px] flex items-center justify-center">
                    {memoCount}
                  </div>
                )}
              </button>
            );
          })}
        </div>
      </section>
//3
      {/* âœ… í•™ìŠµ ìš”ì•½ */}
      <section className="bg-white rounded-lg border p-4">
        <h2 className="font-semibold mb-2">
          ğŸ“Š {dayjs(selectedDate).format('YYYY.MM.DD (ddd)')} í•™ìŠµ ìš”ì•½
        </h2>
        {summaryData.length === 0 ? (
          <p className="text-gray-500 text-sm">í•´ë‹¹ ë‚ ì§œì˜ ê³„íš ë° ì‹¤ì œ ê³µë¶€ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        ) : (
          <ResponsiveContainer width="100%" height={260}>
            <BarChart data={summaryData}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="subject" />
              <YAxis />
              <Tooltip />
              <Legend />
              <Bar dataKey="ê³„íš" fill={COLOR_PLAN}>
                <LabelList dataKey="ê³„íš" position="top" />
              </Bar>
              <Bar dataKey="ì‹¤ì œ" fill={COLOR_ACTUAL}>
                <LabelList dataKey="ì‹¤ì œ" position="top" />
              </Bar>
            </BarChart>
          </ResponsiveContainer>
        )}
      </section>

      {/* âœ… ì´ì „ ë©”ëª¨ + ëŒ€ì‹œë³´ë“œ ì¹´ë“œ ìë¦¬ */}
      <section className="bg-white rounded-lg border p-4 space-y-4">
        <h2 className="font-semibold mb-3">ğŸ“š ì´ì „ ë©”ëª¨ & ëŒ€ì‹œë³´ë“œ ì¹´ë“œ</h2>

        {/* ì˜ˆì‹œë¡œ 3ê°œì˜ ëŒ€ì‹œë³´ë“œ ì¹´ë“œ ìŠ¬ë¡¯ */}
        <div className="grid grid-cols-1 gap-3">
          <div className="p-3 border rounded-lg shadow-sm">ğŸ“ˆ ê³¼ëª©ë³„ ì‹¤ì²œìœ¨ ì¹´ë“œ</div>
          <div className="p-3 border rounded-lg shadow-sm">ğŸ“† ì£¼ê°„ ì´ ê³µë¶€ì‹œê°„ ì¹´ë“œ</div>
          <div className="p-3 border rounded-lg shadow-sm">ğŸ† ëª©í‘œ ë‹¬ì„±ë„ ì¹´ë“œ</div>
        </div>
      </section>
    </main>
  );
}

/** ê³¼ëª©ë³„ ë¹„êµ í•¨ìˆ˜ */
function mergeSubjectCompare(plans: any[], sessions: any[]) {
  const pMap: Record<string, number> = {};
  plans.forEach((p) => {
    const subj = p.subject || 'ê¸°íƒ€';
    const dur = dayjs(p.end_at).diff(dayjs(p.start_at), 'minute');
    pMap[subj] = (pMap[subj] || 0) + Math.max(0, dur);
  });

  const sMap: Record<string, number> = {};
  sessions.forEach((s) => {
    const subj = s.subject || 'ê¸°íƒ€';
    const dur = s.duration_min ?? dayjs(s.actual_end).diff(dayjs(s.actual_start), 'minute');
    sMap[subj] = (sMap[subj] || 0) + Math.max(0, dur);
  });

  const subjects = Array.from(new Set([...Object.keys(pMap), ...Object.keys(sMap)]));
  return subjects.map((subj) => {
    const plan = pMap[subj] || 0;
    const actual = sMap[subj] || 0;
    const rate = plan > 0 ? Math.round((actual / plan) * 100) : 0;
    return { subject: subj, ê³„íš: plan, ì‹¤ì œ: actual, ì‹¤ì²œìœ¨: rate };
  });
}
