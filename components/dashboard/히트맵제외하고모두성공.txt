'use client';

import { useEffect, useMemo, useState } from 'react';
import dayjs from 'dayjs';
import { Card, CardContent } from '@/components/ui/card';
import * as SB from '@/lib/supabaseClient';

// ğŸ“Š ëŒ€ì‹œë³´ë“œ ì¹´ë“œ import
import WeeklySummaryCard from '@/components/dashboard/WeeklySummaryCard';
import AccumulatedFocusCard from '@/components/dashboard/AccumulatedFocusCard';
import FocusGaugeCard from '@/components/dashboard/FocusGaugeCard';
import MonthlyTotalCard from '@/components/dashboard/MonthlyTotalCard';
import PlanActualCard from '@/components/dashboard/PlanActualCard';
import SubjectFocusCard from '@/components/dashboard/SubjectFocusCard';
import TimeOfDayFocusCard from '@/components/dashboard/TimeOfDayFocusCard';
import TodayEfficiencyCard from '@/components/dashboard/TodayEfficiencyCard';
import WeeklyChangeCard from '@/components/dashboard/WeeklyChangeCard';

const pickSupabase = () =>
  typeof (SB as any).getSupabaseBrowser === 'function'
    ? (SB as any).getSupabaseBrowser()
    : (SB as any).getSupabaseClient();

export default function ViewerDashboard({ viewerId }: { viewerId: string }) {
  const supabase = useMemo(() => pickSupabase(), []);
  const [aiSummary, setAiSummary] = useState<string | null>(null);
  const [planMin, setPlanMin] = useState(0);
  const [actualMin, setActualMin] = useState(0);
  const [memo, setMemo] = useState('');
  const [todayComments, setTodayComments] = useState<any[]>([]);

  // ======================
  // ğŸ”¹ 1ï¸âƒ£ AI ìš”ì•½ ë¡œë“œ
  // ======================
  useEffect(() => {
    if (viewerId) loadAISummary();
  }, [viewerId]);

  const loadAISummary = async () => {
    const { data } = await supabase
      .from('dashboard_ai')
      .select('summary')
      .eq('user_id', viewerId)
      .order('created_at', { ascending: false })
      .limit(1)
      .maybeSingle();

    if (data?.summary) setAiSummary(data.summary);
    else loadManualSummary(); // ë°ì´í„° ì—†ì„ ë•Œ ê¸°ë³¸ ìƒì„±
  };

  const loadManualSummary = async () => {
    const start = dayjs().startOf('week').add(1, 'day');
    const end = start.add(6, 'day');

    const [plansRes, sessRes] = await Promise.all([
      supabase
        .from('plans')
        .select('start_at,end_at')
        .eq('user_id', viewerId)
        .gte('start_at', start.toISOString())
        .lte('end_at', end.toISOString()),
      supabase
        .from('sessions')
        .select('actual_start,actual_end,duration_min')
        .eq('user_id', viewerId)
        .gte('actual_start', start.toISOString())
        .lte('actual_end', end.toISOString()),
    ]);

    const plans = plansRes.data || [];
    const sessions = sessRes.data || [];

    const plan = plans.reduce(
      (s, p) => s + dayjs(p.end_at).diff(dayjs(p.start_at), 'minute'),
      0
    );
    const act = sessions.reduce((s, p) => s + (p.duration_min ?? 0), 0);

    setPlanMin(plan);
    setActualMin(act);
  };

  // ======================
  // ğŸ”¹ 2ï¸âƒ£ ì˜¤ëŠ˜ì˜ ë©”ëª¨ ê´€ë¦¬
  // ======================
  useEffect(() => {
    if (viewerId) loadTodayMemos();
  }, [viewerId]);

  const loadTodayMemos = async () => {
    const today = dayjs().format('YYYY-MM-DD');
    const { data } = await supabase
      .from('dashboard_comments')
      .select('*')
      .eq('user_id', viewerId)
      .gte('created_at', `${today}T00:00:00`)
      .lte('created_at', `${today}T23:59:59`)
      .order('created_at', { ascending: true });
    setTodayComments(data || []);
  };

  const saveMemo = async () => {
    if (!memo.trim()) return;
    await supabase.from('dashboard_comments').insert({
      user_id: viewerId,
      content: memo,
      parent_id: null,
    });
    setMemo('');
    loadTodayMemos();
  };

  // ======================
  // ğŸ”¹ 3ï¸âƒ£ ì‹¤ì²œìœ¨ ê³„ì‚°
  // ======================
  const rate = planMin ? Math.round((actualMin / planMin) * 100) : 0;
  const rateMsg =
    rate === 0
      ? 'ì €ì¡°í•œ í¸ì…ë‹ˆë‹¤. ì¢€ ë” ë¶„ë°œí•˜ì—¬ ì£¼ì„¸ìš”.'
      : rate < 40
      ? 'ì €ì¡°í•œ í¸ì…ë‹ˆë‹¤. ì¢€ ë” ë¶„ë°œí•˜ì—¬ ì£¼ì„¸ìš”.'
      : rate < 80
      ? 'ì–‘í˜¸í•œ í¸ì…ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì•„ì§ ì¡°ê¸ˆ ë¶€ì¡±í•©ë‹ˆë‹¤. í˜ë‚´ì„¸ìš”. í™”ì´íŒ…!!'
      : 'ì™€ìš°~~ ì—´ì‹¬íˆ í•˜ê³  ìˆêµ°ìš”. ì¡°ê¸ˆë§Œ ë” í˜ë‚´ì„œ ëª©í‘œë¥¼ ë‹¬ì„±í•˜ë„ë¡ í•´ìš”!!';

  const planH = Math.floor(planMin / 60);
  const planM = planMin % 60;
  const actH = Math.floor(actualMin / 60);
  const actM = actualMin % 60;

  return (
    <div className="space-y-8">
      {/* 1ï¸âƒ£ AI ìš”ì•½ ì¹´ë“œ */}
      <Card className="bg-gradient-to-r from-blue-50 to-teal-50 border border-blue-200">
        <CardContent className="p-5">
          <h2 className="text-lg font-semibold mb-2">ğŸ¤– AI í•™ìŠµ ìš”ì•½</h2>
          {aiSummary ? (
            <p className="leading-relaxed whitespace-pre-wrap">{aiSummary}</p>
          ) : (
            <p className="text-gray-700">
              ë§¤ì£¼ ì¼ìš”ì¼ AI í•™ìŠµ ìš”ì•½ì´ ìƒì„±ë©ë‹ˆë‹¤. ì•„ì§ í•™ìŠµì— ëŒ€í•œ ìš”ì•½ì´ ìƒì„±ë˜ì§€
              ì•Šì•˜ìŠµë‹ˆë‹¤. <br />
              í˜„ì¬ê¹Œì§€ ê³„íš ê³µë¶€ ì‹œê°„ì€ {planH}ì‹œê°„ {planM}ë¶„ì´ë©° ì‹¤ì œ ê³µë¶€ ì‹œê°„ì€{' '}
              {actH}ì‹œê°„ {actM}ë¶„ì…ë‹ˆë‹¤. <br />
              ì´ì— ë”°ë¥¸ ì‹¤ì²œìœ¨ì€ {rate}%ë¡œ {rateMsg}
            </p>
          )}
        </CardContent>
      </Card>

      {/* 2ï¸âƒ£ ì˜¤ëŠ˜ì˜ ë©”ëª¨ */}
      <Card>
        <CardContent className="p-4">
          <h2 className="font-semibold mb-3">ğŸ“ ì˜¤ëŠ˜ì˜ ë©”ëª¨</h2>
          <textarea
            value={memo}
            onChange={(e) => setMemo(e.target.value)}
            placeholder="ì˜¤ëŠ˜ ëŠë‚€ ì ì´ë‚˜ ê¸°ë¡ì„ ì ì–´ë³´ì„¸ìš”..."
            className="w-full p-2 border rounded-md mb-3 h-24 focus:ring-2 focus:ring-blue-300"
          />
          <button
            onClick={saveMemo}
            className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
          >
            ì €ì¥
          </button>

          {todayComments.length > 0 && (
            <div className="mt-4 space-y-2">
              {todayComments.map((c) => (
                <div
                  key={c.id}
                  className="p-2 bg-gray-50 border rounded-md text-sm text-gray-700"
                >
                  <span className="font-medium mr-2">
                    {dayjs(c.created_at).format('HH:mm')}
                  </span>
                  {c.content}
                </div>
              ))}
            </div>
          )}
        </CardContent>
      </Card>

      {/* 3ï¸âƒ£ íˆíŠ¸ë§µ */}
      <Card>
        <CardContent className="p-4">
          <h2 className="font-semibold mb-3">ğŸ”¥ í•™ìŠµ íˆíŠ¸ë§µ</h2>
          <p className="text-sm text-gray-500">
            (íˆíŠ¸ë§µ í´ë¦­ ì‹œ ì¼ìë³„ ì„¸ë¶€ ê³„íš/ì„¸ì…˜ì„ í‘œì‹œí•˜ë„ë¡ êµ¬ì„± ì˜ˆì •)
          </p>
          <div className="mt-4 h-32 bg-gray-100 flex items-center justify-center rounded-md text-gray-400">
            [íˆíŠ¸ë§µ í‘œì‹œ ì˜ì—­]
          </div>
        </CardContent>
      </Card>

      {/* 4ï¸âƒ£ í•˜ë‹¨ - í†µí•© ì¹´ë“œ */}
      <section className="bg-white rounded-lg border p-4 space-y-4">
        <h2 className="font-semibold mb-3">ğŸ“š í•™ìŠµ ìš”ì•½ ëŒ€ì‹œë³´ë“œ</h2>
        <div className="grid grid-cols-1 xl:grid-cols-2 gap-4">
          <WeeklySummaryCard viewerId={viewerId} />
          <AccumulatedFocusCard viewerId={viewerId} />
          <FocusGaugeCard viewerId={viewerId} />
          <MonthlyTotalCard viewerId={viewerId} />
          <PlanActualCard viewerId={viewerId} />
          <SubjectFocusCard viewerId={viewerId} />
          <TimeOfDayFocusCard viewerId={viewerId} />
          <TodayEfficiencyCard viewerId={viewerId} />
          <WeeklyChangeCard viewerId={viewerId} />
        </div>
      </section>
    </div>
  );
}
