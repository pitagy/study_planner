'use client';

import { useEffect, useMemo, useState } from 'react';
import dayjs from 'dayjs';
import 'dayjs/locale/ko';
import * as SB from '@/lib/supabaseClient';
import { Card, CardContent } from '@/components/ui/card';
import Modal from '@/components/ui/Modal';

// ì¹´ë“œë“¤
import SubjectFocusCard from './SubjectFocusCard';
import PlanActualCard from './PlanActualCard';
import FocusGaugeCard from './FocusGaugeCard';
import WeeklyChangeCard from './WeeklyChangeCard';
import WeeklySummaryCard from './WeeklySummaryCard';
import TimeOfDayFocusCard from './TimeOfDayFocusCard';
import TodayEfficiencyCard from './TodayEfficiencyCard';
import AccumulatedFocusCard from './AccumulatedFocusCard';
import MonthlyTotalCard from './MonthlyTotalCard';

dayjs.locale('ko');
const WEEK_LABELS = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];
const pickSupabase = () =>
  typeof (SB as any).getSupabaseBrowser === 'function'
    ? (SB as any).getSupabaseBrowser()
    : (SB as any).getSupabaseClient();

function heatColor(v: number) {
  if (v <= 0) return '#e5e7eb';
  if (v < 60) return '#bfdbfe';
  if (v < 120) return '#93c5fd';
  if (v < 180) return '#60a5fa';
  if (v < 300) return '#3b82f6';
  return '#1d4ed8';
}

function formatMinutesToHourMin(minutes: number) {
  if (!minutes || minutes <= 0) return '0ë¶„';
  const h = Math.floor(minutes / 60);
  const m = minutes % 60;
  return h > 0 ? `${h}ì‹œê°„ ${m}ë¶„` : `${m}ë¶„`;
}

export default function ViewerDashboard({ viewerId, viewerName, viewerRole = 'student' }: any) {
  const supabase = useMemo(() => pickSupabase(), []);
  const [myUid, setMyUid] = useState<string | null>(null);
  const [displayName, setDisplayName] = useState('ëŒ€ì‹œë³´ë“œ');
  const [loading, setLoading] = useState(true);

  const [aiSummary, setAiSummary] = useState('');
  const [aiRange, setAiRange] = useState('');
  const [heatmapDays, setHeatmapDays] = useState<any[]>([]);
  const [memoDates, setMemoDates] = useState<string[]>([]);

  // ì˜¤ëŠ˜ì˜ ë©”ëª¨
  const [todayMemos, setTodayMemos] = useState<any[]>([]);

  // ëª¨ë‹¬ ìƒíƒœ
  const [showModal, setShowModal] = useState(false);
  const [selectedDate, setSelectedDate] = useState<string | null>(null);
  const [selectedSummary, setSelectedSummary] = useState<string>('');
  const [selectedMemo, setSelectedMemo] = useState<any[]>([]);
  const [newMemo, setNewMemo] = useState('');
  const [replyTo, setReplyTo] = useState<string | null>(null);

  useEffect(() => {
    (async () => {
      const { data: auth } = await supabase.auth.getUser();
      setMyUid(auth?.user?.id ?? null);
    })();
  }, [supabase]);

  useEffect(() => {
    if (viewerId) loadAll();
  }, [viewerId]);

  // ğŸ”¹ ì „ì²´ ë°ì´í„° ë¡œë“œ
  const loadAll = async () => {
    setLoading(true);
    try {
      const today = dayjs();
      const startOfWeek = today.startOf('week');
      const endOfWeek = today.endOf('week');
      const startOfMonth = today.startOf('month');
      const endOfMonth = today.endOf('month');

      // ì´ë¦„
      const { data: profile } = await supabase
        .from('profiles')
        .select('name,email')
        .eq('id', viewerId)
        .single();
      const name = profile?.name || profile?.email?.split('@')[0] || 'í•™ìƒ';
      setDisplayName(`${viewerName || name} í•™ìƒì˜ ëŒ€ì‹œë³´ë“œ`);

      // AI ìš”ì•½
      const { data: ai } = await supabase
        .from('dashboard_ai')
        .select('*')
        .eq('user_id', viewerId)
        .gte('start_date', startOfWeek.format('YYYY-MM-DD'))
        .lte('end_date', endOfWeek.format('YYYY-MM-DD'))
        .maybeSingle();

      // ê³µë¶€ í†µê³„
      const { data: plans } = await supabase
        .from('plans')
        .select('start_at,end_at')
        .eq('user_id', viewerId)
        .gte('start_at', startOfWeek.toISOString())
        .lte('end_at', endOfWeek.toISOString());

      const { data: sessions } = await supabase
        .from('sessions')
        .select('actual_start,actual_end,duration_min')
        .eq('user_id', viewerId)
        .gte('actual_start', startOfWeek.toISOString())
        .lte('actual_end', endOfWeek.toISOString());

      const planTotal = (plans || []).reduce(
        (sum, p) => sum + dayjs(p.end_at).diff(dayjs(p.start_at), 'minute'),
        0
      );
      const actualTotal = (sessions || []).reduce(
        (sum, s) => sum + (s.duration_min ?? dayjs(s.actual_end).diff(dayjs(s.actual_start), 'minute')),
        0
      );
      const rate = planTotal > 0 ? Math.round((actualTotal / planTotal) * 100) : 0;

      if (ai?.summary) {
        setAiSummary(ai.summary);
        setAiRange(`${startOfWeek.format('M/D(ì›”)')}~${endOfWeek.format('M/D(ì¼)')} AI í•™ìŠµ ìš”ì•½`);
      } else {
        let comment = '';
        if (rate <= 40) comment = 'ì €ì¡°í•œ í¸ì…ë‹ˆë‹¤. ì¢€ ë” ë¶„ë°œí•˜ì—¬ ì£¼ì„¸ìš”.';
        else if (rate <= 79)
          comment = 'ì–‘í˜¸í•œ í¸ì…ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì•„ì§ ì¡°ê¸ˆ ë¶€ì¡±í•©ë‹ˆë‹¤. í˜ë‚´ì„¸ìš”. í™”ì´íŒ…!!';
        else comment = 'ì™€ìš°~~ ì—´ì‹¬íˆ í•˜ê³  ìˆêµ°ìš”. ì¡°ê¸ˆë§Œ ë” í˜ë‚´ì„œ ëª©í‘œë¥¼ ë‹¬ì„±í•˜ë„ë¡ í•´ìš”!!';

        setAiSummary(
          `ë§¤ì£¼ ì¼ìš”ì¼ AI í•™ìŠµ ìš”ì•½ì´ ìƒì„±ë©ë‹ˆë‹¤. ì•„ì§ í•™ìŠµì— ëŒ€í•œ ìš”ì•½ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
í˜„ì¬ê¹Œì§€ ê³„íš ê³µë¶€ ì‹œê°„ì€ ${formatMinutesToHourMin(planTotal)}ì´ë©° ì‹¤ì œ ê³µë¶€ ì‹œê°„ì€ ${formatMinutesToHourMin(actualTotal)}ì…ë‹ˆë‹¤.
ì´ì— ë”°ë¥¸ ì‹¤ì²œìœ¨ì€ ${rate}%ë¡œ ${comment}`
        );
        setAiRange(`${startOfWeek.format('M/D(ì›”)')}~${endOfWeek.format('M/D(ì¼)')}`);
      }

      // ğŸ”¹ íˆíŠ¸ë§µ
      const { data: monthSessions } = await supabase
        .from('sessions')
        .select('actual_start,duration_min')
        .eq('user_id', viewerId)
        .gte('actual_start', startOfMonth.toISOString())
        .lte('actual_start', endOfMonth.toISOString());

      const { data: memos } = await supabase
        .from('dashboard_comments')
        .select('date')
        .eq('user_id', viewerId)
        .gte('date', startOfMonth.format('YYYY-MM-DD'))
        .lte('date', endOfMonth.format('YYYY-MM-DD'));

      const memoMarked = Array.from(new Set((memos || []).map((m) => m.date)));
      setMemoDates(memoMarked);

      const map = new Map();
      (monthSessions || []).forEach((s) => {
        const date = dayjs(s.actual_start).format('YYYY-MM-DD');
        map.set(date, (map.get(date) || 0) + (s.duration_min ?? 0));
      });

      const days = [];
      for (let i = 0; i < startOfMonth.day(); i++) days.push({ date: `blank-${i}`, blank: true });
      for (let d = 1; d <= endOfMonth.date(); d++) {
        const dateStr = startOfMonth.date(d).format('YYYY-MM-DD');
        days.push({ date: dateStr, minutes: map.get(dateStr) || 0 });
      }
      setHeatmapDays(days);

      // ğŸ”¹ ì˜¤ëŠ˜ì˜ ë©”ëª¨
      const todayStr = today.format('YYYY-MM-DD');
      const { data: todayList } = await supabase
        .from('dashboard_comments')
        .select('*')
        .eq('user_id', viewerId)
        .eq('date', todayStr)
        .order('created_at', { ascending: true });
      setTodayMemos(todayList || []);
    } finally {
      setLoading(false);
    }
  };

  // ğŸ”¹ ë‚ ì§œ í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸°
  const handleDayClick = async (date: string) => {
    if (!date || date.startsWith('blank')) return;

    const { data: sessions } = await supabase
      .from('sessions')
      .select('subject,actual_start,actual_end,duration_min')
      .eq('user_id', viewerId)
      .gte('actual_start', dayjs(date).startOf('day').toISOString())
      .lte('actual_end', dayjs(date).endOf('day').toISOString());

    const { data: comments } = await supabase
      .from('dashboard_comments')
      .select('id,parent_id,author_name,role,content,created_at')
      .eq('user_id', viewerId)
      .eq('date', date)
      .order('created_at', { ascending: true });

    const total = (sessions || []).reduce(
      (sum, s) => sum + (s.duration_min ?? dayjs(s.actual_end).diff(dayjs(s.actual_start), 'minute')),
      0
    );

    const summary = sessions?.length
      ? `ì´ ${formatMinutesToHourMin(total)} ê³µë¶€ (${sessions.length}íšŒ ê¸°ë¡)`
      : 'ì´ë‚ ì˜ ê³µë¶€ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.';

    setSelectedDate(date);
    setSelectedSummary(summary);
    setSelectedMemo(comments || []);
    setShowModal(true);
  };

  // ğŸ”¹ ë©”ëª¨ ì €ì¥ (ì›ê¸€ ë˜ëŠ” ëŒ€ëŒ“ê¸€)
  const handleSaveMemo = async () => {
    if (!newMemo.trim() || !selectedDate) return;

    await supabase.from('dashboard_comments').insert([
      {
        user_id: viewerId,
        date: selectedDate,
        content: newMemo,
        parent_id: replyTo || null,
        author_name: viewerName || 'í•™ìƒ',
        role: viewerRole,
        created_at: new Date().toISOString(),
      },
    ]);

    setNewMemo('');
    setReplyTo(null);
    handleDayClick(selectedDate);
  };

  if (loading) return <main className="p-6 text-gray-600">ğŸ“Š ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</main>;

  return (
    <main className="p-6 space-y-8">
      <h1 className="text-2xl font-bold">{displayName}</h1>

      {/* âœ… AI ìš”ì•½ */}
      <section className="bg-gradient-to-r from-indigo-50 to-white border rounded-lg p-4 shadow-sm">
        <h2 className="font-semibold mb-1 text-indigo-700">ğŸ¤– {aiRange}</h2>
        <p className="text-gray-700 whitespace-pre-wrap">{aiSummary}</p>
      </section>

      {/* âœ… ì˜¤ëŠ˜ì˜ ë©”ëª¨ */}
      <Card>
        <CardContent className="p-4">
          <h2 className="font-semibold mb-2">ğŸ“ ì˜¤ëŠ˜ì˜ ë©”ëª¨ ({dayjs().format('Mì›” Dì¼')})</h2>
          {todayMemos.length > 0 ? (
            <ul className="space-y-3 text-sm">
              {todayMemos
                .filter((m) => !m.parent_id)
                .map((root) => (
                  <li key={root.id} className="border rounded-md p-3 bg-gray-50">
                    <div className="flex justify-between">
                      <span>
                        <b>{root.author_name}</b> ({root.role}) : {root.content}
                      </span>
                      <span className="text-xs text-gray-400">
                        {dayjs(root.created_at).format('HH:mm')}
                      </span>
                    </div>
                    {todayMemos
                      .filter((r) => r.parent_id === root.id)
                      .map((reply) => (
                        <div
                          key={reply.id}
                          className="ml-5 mt-2 border-l-2 border-gray-300 pl-3 text-gray-700 flex justify-between"
                        >
                          <span>
                            â†³ <b>{reply.author_name}</b> ({reply.role}) : {reply.content}
                          </span>
                          <span className="text-xs text-gray-400">
                            {dayjs(reply.created_at).format('HH:mm')}
                          </span>
                        </div>
                      ))}
                  </li>
                ))}
            </ul>
          ) : (
            <p className="text-gray-500 text-sm">ì˜¤ëŠ˜ ì‘ì„±ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
          )}
        </CardContent>
      </Card>

      {/* âœ… íˆíŠ¸ë§µ */}
      <Card>
        <CardContent className="p-4">
          <h2 className="font-semibold mb-3">ğŸ”¥ í•™ìŠµ íˆíŠ¸ë§µ</h2>
          <div className="grid grid-cols-7 text-center text-xs font-semibold text-gray-600 mb-1">
            {WEEK_LABELS.map((d) => (
              <div key={d}>{d}</div>
            ))}
          </div>
          <div className="grid grid-cols-7 gap-2 justify-items-center">
            {heatmapDays.map((d) =>
              d.blank ? (
                <div key={d.date} className="h-14 w-14" />
              ) : (
                <button
                  key={d.date}
                  onClick={() => handleDayClick(d.date)}
                  className="relative h-14 w-14 rounded-lg border flex items-center justify-center text-xs font-medium hover:ring-2 hover:ring-blue-400 transition"
                  style={{ backgroundColor: heatColor(d.minutes) }}
                >
                  {dayjs(d.date).date()}
                  {memoDates.includes(d.date) && (
                    <div className="absolute right-1 top-1 w-2 h-2 bg-blue-600 rounded-full"></div>
                  )}
                </button>
              )
            )}
          </div>
        </CardContent>
      </Card>

      {/* âœ… ì¹´ë“œ 9ê°œ */}
      <section className="bg-white rounded-lg border p-4 space-y-4">
        <h2 className="font-semibold mb-3">ğŸ“š í•™ìŠµ ìš”ì•½ ëŒ€ì‹œë³´ë“œ</h2>
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-3">
          <SubjectFocusCard viewerId={viewerId} />
          <PlanActualCard viewerId={viewerId} />
          <WeeklyChangeCard viewerId={viewerId} />
        </div>
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-3">
          <WeeklySummaryCard viewerId={viewerId} />
          <TimeOfDayFocusCard viewerId={viewerId} />
          <TodayEfficiencyCard viewerId={viewerId} />
        </div>
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-3">
          <FocusGaugeCard viewerId={viewerId} />
          <AccumulatedFocusCard viewerId={viewerId} />
          <MonthlyTotalCard viewerId={viewerId} />
        </div>
      </section>

      {/* âœ… ë©”ëª¨ ëª¨ë‹¬ */}
      {showModal && (
        <Modal onClose={() => setShowModal(false)}>
          <div className="p-4">
            <h3 className="font-semibold text-lg mb-2">
              {dayjs(selectedDate).format('YYYYë…„ Mì›” Dì¼')} í•™ìŠµ ìš”ì•½
            </h3>
            <p className="mb-3 text-gray-700">{selectedSummary}</p>

            <h4 className="font-semibold text-sm text-gray-600 mb-1">ğŸ’¬ ë©”ëª¨</h4>
            {selectedMemo.length > 0 ? (
              <ul className="space-y-3 text-sm">
                {selectedMemo
                  .filter((m) => !m.parent_id)
                  .map((root) => (
                    <li key={root.id} className="border rounded-md p-3 bg-gray-50">
                      <div className="flex justify-between">
                        <span>
                          <b>{root.author_name}</b> ({root.role}) : {root.content}
                        </span>
                        <span className="text-xs text-gray-400">
                          {dayjs(root.created_at).format('HH:mm')}
                        </span>
                      </div>
                      {selectedMemo
                        .filter((r) => r.parent_id === root.id)
                        .map((reply) => (
                          <div
                            key={reply.id}
                            className="ml-5 mt-2 border-l-2 border-gray-300 pl-3 text-gray-700 flex justify-between"
                          >
                            <span>
                              â†³ <b>{reply.author_name}</b> ({reply.role}) : {reply.content}
                            </span>
                            <span className="text-xs text-gray-400">
                              {dayjs(reply.created_at).format('HH:mm')}
                            </span>
                          </div>
                        ))}
                      <button
                        className="text-blue-600 text-xs mt-2 hover:underline"
                        onClick={() => setReplyTo(root.id)}
                      >
                        â†³ ë‹µê¸€ ë‹¬ê¸°
                      </button>
                    </li>
                  ))}
              </ul>
            ) : (
              <p className="text-sm text-gray-500">ì•„ì§ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            )}

            <div className="mt-4">
              {replyTo && (
                <p className="text-xs text-gray-500 mb-1">
                  ğŸ’¬ <b>{selectedMemo.find((m) => m.id === replyTo)?.author_name}</b>ë‹˜ì—ê²Œ ë‹µê¸€ ì¤‘...
                  <button
                    className="ml-2 text-red-500 text-xs underline"
                    onClick={() => setReplyTo(null)}
                  >
                    ì·¨ì†Œ
                  </button>
                </p>
              )}
              <textarea
                value={newMemo}
                onChange={(e) => setNewMemo(e.target.value)}
                placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                className="w-full border rounded p-2 mb-2 resize-none h-24"
              />
              <button
                onClick={handleSaveMemo}
                className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
              >
                ì €ì¥
              </button>
            </div>
          </div>
        </Modal>
      )}
    </main>
  );
}
